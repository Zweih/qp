#!/bin/bash
CACHE_MARKER="/tmp/update-qp-cache-needed"
LOCK_FILE="/tmp/update-qp-cache.lock"

is_daemon_running() {
  [ -f "$LOCK_FILE" ]
}

signal_cache_needed() {
  touch "$CACHE_MARKER"
}

cleanup_daemon() {
  rm -f "$LOCK_FILE"
}

rebuild_cache_if_needed() {
  if [ -f "$CACHE_MARKER" ]; then
    rm -f "$CACHE_MARKER"
    qp --cache-only=pacman >/dev/null 2>&1
  fi
}

start_daemon() {
  (
    (
      touch "$LOCK_FILE"
      cycles=0
      max_cycles=12

      while [ "$cycles" -lt "$max_cycles" ]; do
        sleep 5
        cycles=$((cycles + 1))
        rebuild_cache_if_needed
      done

      cleanup_daemon
    ) &
  ) &
}

if is_daemon_running; then
  signal_cache_needed
else
  signal_cache_needed
  start_daemon
fi
