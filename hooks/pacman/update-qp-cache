#!/bin/bash
CACHE_MARKER="/tmp/update-qp-cache-needed"
LOCK_FILE="/tmp/update-qp-cache.lock"

if [ ! -f "$LOCK_FILE" ]; then
  touch "$CACHE_MARKER"

  REAL_USER="${SUDO_USER:-$USER}"
  REAL_HOME=$(eval echo "~$REAL_USER")

  setsid bash -c "
      touch /tmp/update-qp-cache.lock
      cycles=0
      max_cycles=6

      while [ \$cycles -lt \$max_cycles ]; do
        sleep 5
        cycles=\$((cycles + 1))

        if [ -f /tmp/update-qp-cache-needed ]; then
          rm -f /tmp/update-qp-cache-needed

          sudo -u '$REAL_USER' HOME='$REAL_HOME' /usr/bin/qp --cache-only=pacman >/dev/null 2>&1
        fi
      done

      rm -f /tmp/update-qp-cache.lock
    " </dev/null >/dev/null 2>&1 &
else
  touch "$CACHE_MARKER"
fi
